#!/bin/bash

# Script de migraÃ§Ã£o para nova estrutura de scripts
# Limpa configuraÃ§Ãµes antigas e configura novas

echo "ğŸ”„ Migrando para Nova Estrutura de Scripts"
echo "=========================================="

# 1. Parar processos antigos
echo "ğŸ›‘ Parando processos antigos..."
pkill -f "guardiao-watch" 2>/dev/null || true
pkill -f ".local/scripts/guardiao" 2>/dev/null || true

# 2. Limpar logs antigos
echo "ğŸ§¹ Limpando logs antigos..."
rm -f ~/.guardiao.log
rm -f .guardiao.log
rm -f .tsc.log

# 3. Verificar nova estrutura
echo "ğŸ“ Verificando nova estrutura..."
if [ ! -f "scripts/guardiao-watch.js" ]; then
    echo "âŒ Nova estrutura nÃ£o encontrada. Certifique-se de estar na raiz do projeto."
    exit 1
fi

if [ ! -f "scripts/coderabbit-analysis.sh" ]; then
    echo "âŒ Scripts do CodeRabbit nÃ£o encontrados."
    exit 1
fi

echo "âœ… Nova estrutura verificada"

# 4. Atualizar permissÃµes
echo "ğŸ”§ Atualizando permissÃµes..."
chmod +x scripts/*.sh
chmod +x scripts/coderabbit
chmod +x scripts/guardiao-watch.js
chmod +x start-dev
chmod +x setup-guardiao

# 5. Teste rÃ¡pido
echo "ğŸ§ª Testando nova estrutura..."
if timeout 5s node scripts/guardiao-watch.js > /dev/null 2>&1 &; then
    TEST_PID=$!
    sleep 2
    if ps -p $TEST_PID > /dev/null 2>&1; then
        kill $TEST_PID
        echo "âœ… GuardiÃ£o funciona na nova estrutura"
    else
        echo "âŒ Erro no teste do GuardiÃ£o"
        exit 1
    fi
fi

# 6. InformaÃ§Ãµes finais
echo ""
echo "ğŸ‰ MigraÃ§Ã£o completa!"
echo ""
echo "ğŸ“‹ Comandos atualizados:"
echo "  npm run dev              # Ambiente completo"
echo "  npm run guardiao:start   # Apenas GuardiÃ£o"
echo "  npm run guardiao:status  # Ver status"
echo "  npm run coderabbit       # AnÃ¡lise de PRs"
echo ""
echo "ğŸ”— Scripts principais:"
echo "  ./start-dev              # Iniciar desenvolvimento"
echo "  ./scripts/coderabbit     # CodeRabbit direto"
echo ""
echo "âœ¨ Agora todos os scripts estÃ£o versionados no Git!"