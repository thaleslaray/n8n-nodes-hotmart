#!/bin/bash

# ğŸ›¡ï¸ Setup AutomÃ¡tico do GuardiÃ£o
# Configura tudo para inicializaÃ§Ã£o automÃ¡tica

echo "ğŸ›¡ï¸ Setup do GuardiÃ£o AutomÃ¡tico"
echo "==============================="

# 1. Verificar dependÃªncias
echo "ğŸ“¦ Verificando dependÃªncias..."

if ! command -v node &> /dev/null; then
    echo "âŒ Node.js nÃ£o instalado. Instale primeiro: https://nodejs.org"
    exit 1
fi

if ! command -v npm &> /dev/null; then
    echo "âŒ npm nÃ£o encontrado"
    exit 1
fi

echo "âœ… Node.js e npm encontrados"

# 2. Instalar dependÃªncias se necessÃ¡rio
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ Instalando dependÃªncias..."
    npm install
fi

# 3. Verificar se chokidar estÃ¡ instalado
if ! npm list chokidar &>/dev/null; then
    echo "ğŸ“¦ Instalando chokidar..."
    npm install --save-dev chokidar
fi

echo "âœ… DependÃªncias verificadas"

# 4. Verificar estrutura de arquivos
if [ ! -f "scripts/guardiao-watch.js" ]; then
    echo "âŒ GuardiÃ£o nÃ£o encontrado. Execute este script da raiz do projeto."
    exit 1
fi

if [ ! -f "scripts/dev-with-guardiao.sh" ]; then
    echo "âŒ Script de desenvolvimento nÃ£o encontrado"
    exit 1
fi

echo "âœ… Estrutura de arquivos OK"

# 5. Adicionar ao .gitignore se necessÃ¡rio
if [ -f ".gitignore" ]; then
    if ! grep -q ".guardiao-snapshot.json" .gitignore 2>/dev/null; then
        echo "" >> .gitignore
        echo "# GuardiÃ£o AutomÃ¡tico" >> .gitignore
        echo ".guardiao-snapshot.json" >> .gitignore
        echo ".guardiao.log" >> .gitignore
        echo ".tsc.log" >> .gitignore
        echo "âœ… Adicionado ao .gitignore"
    fi
fi

# 6. Teste rÃ¡pido
echo "ğŸ§ª Testando configuraÃ§Ã£o..."
timeout 5s node scripts/guardiao-watch.js > /dev/null 2>&1 &
TEST_PID=$!
sleep 2

if ps -p $TEST_PID > /dev/null 2>&1; then
    kill $TEST_PID
    echo "âœ… Teste OK - GuardiÃ£o funciona"
else
    echo "âŒ Erro no teste do GuardiÃ£o"
    exit 1
fi

echo ""
echo "ğŸ‰ Setup completo!"
echo ""
echo "ğŸ“‹ Como usar:"
echo "  ./start-dev              # Inicia ambiente completo"
echo "  npm run dev              # Mesma coisa"
echo "  npm run guardiao:status  # Ver status"
echo "  npm run guardiao:stop    # Parar GuardiÃ£o"
echo ""
echo "âœ¨ Agora o GuardiÃ£o inicia automaticamente sempre!"