name: CI - IntegraÃ§Ã£o ContÃ­nua

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  # Job 1: VerificaÃ§Ã£o de Qualidade
  quality:
    name: ğŸ” Qualidade de CÃ³digo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history para anÃ¡lises
    
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: ğŸ’¾ Cache de dependÃªncias
      uses: actions/cache@v3
      with:
        path: |
          ~/.pnpm-store
          **/node_modules
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
          
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ¨ Verificar formataÃ§Ã£o (Lint)
      run: pnpm lint
      
    - name: ğŸ“ Verificar tipos TypeScript
      run: pnpm typecheck
      
    - name: ğŸ”¨ Compilar projeto
      run: pnpm build
      
    - name: ğŸ“Š Verificar tamanho do bundle
      run: |
        echo "ğŸ“¦ Tamanho do build:"
        du -sh dist/
        find dist -name "*.js" -exec ls -lh {} \; | awk '{print $5, $9}'

  # Job 2: Testes
  test:
    name: ğŸ§ª Testes
    runs-on: ubuntu-latest
    needs: quality
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
        
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        
    - name: ğŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: ğŸ’¾ Cache de dependÃªncias
      uses: actions/cache@v3
      with:
        path: |
          ~/.pnpm-store
          **/node_modules
        key: ${{ runner.os }}-node${{ matrix.node-version }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ§ª Executar testes
      run: pnpm test:ci
      env:
        CI: true
        
    - name: ğŸ“Š Gerar relatÃ³rio de cobertura
      if: matrix.node-version == '18.x'  # Apenas uma vez
      run: pnpm test:coverage
      
    - name: ğŸ“ˆ Upload cobertura para Codecov
      if: matrix.node-version == '18.x'
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: unittests
        name: n8n-nodes-hotmart
        fail_ci_if_error: false
        
    - name: ğŸ’¾ Armazenar relatÃ³rios de teste
      if: always() && matrix.node-version == '18.x'
      uses: actions/upload-artifact@v3
      with:
        name: test-reports
        path: |
          coverage/
          test-report-*.json
        retention-days: 7

  # Job 3: SeguranÃ§a
  security:
    name: ğŸ”’ VerificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    needs: quality
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: ğŸ” Audit de dependÃªncias
      run: pnpm audit --production
      continue-on-error: true  # NÃ£o falhar o CI, apenas reportar
      
    - name: ğŸ›¡ï¸ Verificar vulnerabilidades com Snyk
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: snyk/actions/node@master
      continue-on-error: true
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high

  # Job 4: AnÃ¡lise de CÃ³digo
  analyze:
    name: ğŸ“Š AnÃ¡lise de CÃ³digo
    runs-on: ubuntu-latest
    needs: quality
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ” SonarCloud Scan
      if: env.SONAR_TOKEN != ''
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        
    - name: ğŸ“ Verificar complexidade do cÃ³digo
      run: |
        echo "ğŸ“Š AnÃ¡lise de complexidade:"
        npx complexity-report-cli nodes/ --format json > complexity-report.json || true
        
    - name: ğŸš¨ Comentar no PR
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let comment = '## ğŸ“Š RelatÃ³rio de AnÃ¡lise\n\n';
          
          // Adicionar mÃ©tricas bÃ¡sicas
          comment += '### âœ… VerificaÃ§Ãµes Passadas\n';
          comment += '- Lint âœ“\n';
          comment += '- TypeScript âœ“\n';
          comment += '- Build âœ“\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Job 5: Release (apenas no main)
  release-check:
    name: ğŸš€ Verificar Release
    runs-on: ubuntu-latest
    needs: [quality, test, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ğŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: ğŸ“¦ Instalar dependÃªncias
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ·ï¸ Verificar necessidade de release
      id: check
      run: |
        # Verificar se hÃ¡ commits de feat ou fix desde a Ãºltima tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
        COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"%s" | grep -E "^(feat|fix):" | wc -l)
        
        if [ "$COMMITS" -gt 0 ]; then
          echo "needs_release=true" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Nova release necessÃ¡ria! ($COMMITS commits de feat/fix)"
        else
          echo "needs_release=false" >> $GITHUB_OUTPUT
          echo "âœ… Nenhuma mudanÃ§a requer release"
        fi
        
    - name: ğŸ“‹ Gerar CHANGELOG preview
      if: steps.check.outputs.needs_release == 'true'
      run: |
        echo "ğŸ“ Preview do CHANGELOG:"
        npx conventional-changelog-cli -p angular -i CHANGELOG.md -s --dry-run

  # Job 6: NotificaÃ§Ã£o de Status
  notify:
    name: ğŸ“¢ Notificar Status
    runs-on: ubuntu-latest
    needs: [quality, test, security]
    if: always()
    
    steps:
    - name: ğŸ“Š Resumo do CI
      run: |
        echo "## ğŸ“Š Resumo da Build"
        echo ""
        echo "- Quality: ${{ needs.quality.result }}"
        echo "- Tests: ${{ needs.test.result }}"
        echo "- Security: ${{ needs.security.result }}"
        echo ""
        
        if [ "${{ needs.quality.result }}" == "success" ] && \
           [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.security.result }}" == "success" ]; then
          echo "âœ… **Build bem-sucedida!**"
        else
          echo "âŒ **Build falhou!**"
          exit 1
        fi