name: Dependencies - AtualizaÃ§Ã£o e SeguranÃ§a

on:
  schedule:
    # Executar toda segunda-feira Ã s 9h (UTC)
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'package.json'
      - 'pnpm-lock.yaml'

jobs:
  # Verificar vulnerabilidades
  security-check:
    name: ðŸ”’ VerificaÃ§Ã£o de SeguranÃ§a
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ðŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: ðŸ” Audit de dependÃªncias
      id: audit
      run: |
        echo "## ðŸ” RelatÃ³rio de SeguranÃ§a" > security-report.md
        echo "" >> security-report.md
        echo "Data: $(date)" >> security-report.md
        echo "" >> security-report.md
        
        # Executar audit
        if pnpm audit --production; then
          echo "âœ… Nenhuma vulnerabilidade encontrada!" >> security-report.md
        else
          echo "âš ï¸ Vulnerabilidades encontradas:" >> security-report.md
          pnpm audit --production >> security-report.md || true
        fi
        
    - name: ðŸ“Š Upload relatÃ³rio
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 30

  # Atualizar dependÃªncias
  update-dependencies:
    name: ðŸ”„ Atualizar DependÃªncias
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ”§ Configurar Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
    - name: ðŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ðŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: ðŸ“¦ Instalar dependÃªncias
      run: pnpm install
      
    - name: ðŸ”„ Verificar atualizaÃ§Ãµes
      id: check-updates
      run: |
        echo "## ðŸ“¦ DependÃªncias Desatualizadas" > update-report.md
        echo "" >> update-report.md
        
        # Verificar outdated
        pnpm outdated --format json > outdated.json || true
        
        # Processar resultado
        if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
          echo "has_updates=true" >> $GITHUB_OUTPUT
          
          # Formatar relatÃ³rio
          node -e "
            const outdated = require('./outdated.json');
            const deps = Object.entries(outdated);
            
            if (deps.length > 0) {
              console.log('### DependÃªncias com atualizaÃ§Ãµes disponÃ­veis:\n');
              deps.forEach(([name, info]) => {
                console.log(\`- **\${name}**: \${info.current} â†’ \${info.wanted} (latest: \${info.latest})\`);
              });
            }
          " >> update-report.md
        else
          echo "has_updates=false" >> $GITHUB_OUTPUT
          echo "âœ… Todas as dependÃªncias estÃ£o atualizadas!" >> update-report.md
        fi
        
    - name: ðŸ”„ Atualizar dependÃªncias (minor/patch)
      if: steps.check-updates.outputs.has_updates == 'true'
      run: |
        # Atualizar apenas minor e patch
        pnpm update --no-save
        
        # Verificar se houve mudanÃ§as
        if git diff --quiet pnpm-lock.yaml; then
          echo "Nenhuma atualizaÃ§Ã£o aplicada"
        else
          echo "AtualizaÃ§Ãµes aplicadas!"
          git add pnpm-lock.yaml
        fi
        
    - name: ðŸ§ª Executar testes
      if: steps.check-updates.outputs.has_updates == 'true'
      run: |
        pnpm test
        pnpm lint
        pnpm typecheck
        pnpm build
        
    - name: ðŸ”€ Criar Pull Request
      if: steps.check-updates.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: 'chore: atualizar dependÃªncias (minor/patch)'
        title: 'ðŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica de DependÃªncias'
        body: |
          ## ðŸ”„ AtualizaÃ§Ã£o AutomÃ¡tica de DependÃªncias
          
          Este PR foi criado automaticamente para atualizar dependÃªncias minor e patch.
          
          ### ðŸ“‹ O que foi feito:
          - âœ… DependÃªncias atualizadas (apenas minor/patch)
          - âœ… Testes executados com sucesso
          - âœ… Lint e TypeScript verificados
          - âœ… Build testado
          
          ### ðŸ“Š RelatÃ³rio de AtualizaÃ§Ãµes:
          
          ${{ steps.check-updates.outputs.update_report }}
          
          ### âš ï¸ AtenÃ§Ã£o:
          - Revise as mudanÃ§as antes de fazer merge
          - Teste manualmente se possÃ­vel
          - Verifique o CHANGELOG das dependÃªncias principais
          
          ---
          
          ðŸ¤– *PR criado automaticamente pelo GitHub Actions*
        branch: deps/auto-update
        delete-branch: true
        labels: |
          dependencies
          automated
        assignees: thaleslaray
        reviewers: thaleslaray

  # Verificar licenÃ§as
  license-check:
    name: ðŸ“œ VerificaÃ§Ã£o de LicenÃ§as
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout do cÃ³digo
      uses: actions/checkout@v4
      
    - name: ðŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
        
    - name: ðŸ“¦ Instalar pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: ðŸ“¦ Instalar dependÃªncias
      run: pnpm install
      
    - name: ðŸ“œ Verificar licenÃ§as
      run: |
        echo "## ðŸ“œ RelatÃ³rio de LicenÃ§as" > license-report.md
        echo "" >> license-report.md
        
        # Instalar ferramenta
        npm install -g license-checker
        
        # Gerar relatÃ³rio
        license-checker --production --summary >> license-report.md
        
        # Verificar licenÃ§as problemÃ¡ticas
        echo "" >> license-report.md
        echo "### âš ï¸ VerificaÃ§Ã£o de LicenÃ§as ProblemÃ¡ticas:" >> license-report.md
        
        # LicenÃ§as que podem ser problemÃ¡ticas
        PROBLEMATIC="GPL|AGPL|LGPL|SSPL|BUSL"
        
        if license-checker --production | grep -E "$PROBLEMATIC"; then
          echo "âŒ Encontradas licenÃ§as que podem ser incompatÃ­veis!" >> license-report.md
          license-checker --production | grep -E "$PROBLEMATIC" >> license-report.md
        else
          echo "âœ… Nenhuma licenÃ§a problemÃ¡tica encontrada!" >> license-report.md
        fi
        
    - name: ðŸ“Š Upload relatÃ³rio
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: license-report
        path: license-report.md
        retention-days: 30