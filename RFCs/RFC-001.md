# RFC-001: Estrutura Base MCP

## Resumo

Este RFC define a implementação fundamental da integração do Node Hotmart com o Model Context Protocol (MCP). Ele estabelece a estrutura base necessária para que o node Hotmart seja reconhecido como uma ferramenta compatível com MCP, adicionando a propriedade `usableAsTool` e todos os componentes básicos necessários para a integração com o protocolo MCP.

## Funcionalidades/Features Abordadas

- **F1: Propriedade usableAsTool no Node Hotmart Principal**
- **F2: Propriedade usableAsTool no HotmartV1**
- **F3: Propriedade usableAsTool no HotmartTrigger**
- **F4: Estrutura de MCP para Node Hotmart**
- **F5: Compatibilidade com Fluxo de Trabalho MCP**
- **F6: Configuração de Ambiente MCP**

## Abordagem Técnica

### Visão Geral

A abordagem técnica consiste em adicionar a propriedade `usableAsTool: true` nos arquivos de definição do node Hotmart e implementar a estrutura básica para conformidade com o protocolo MCP, sem ainda modificar as descrições detalhadas ou implementar processamento de linguagem natural. É a fundação sobre a qual construiremos as funcionalidades mais avançadas.

### Arquitetura

Esta implementação segue a arquitetura existente do node Hotmart, mantendo sua estrutura modular. As principais modificações serão feitas em:

1. **Hotmart.node.ts**: Adição da propriedade `usableAsTool: true` na descrição base
2. **HotmartV1.node.ts**: Garantia de que a propriedade seja propagada corretamente
3. **HotmartTrigger.node.ts**: Adição da propriedade `usableAsTool: true` se aplicável

A estrutura de arquivos permanecerá a mesma, sem a adição de novos arquivos neste RFC, apenas modificações nos existentes.

### Dependências e Sequência

Este é o primeiro RFC e não depende de implementações anteriores. Todos os RFCs subsequentes dependerão desta implementação fundamental.

## Especificações Técnicas Detalhadas

### 1. Hotmart.node.ts

Modificação da classe principal do node Hotmart para incluir a propriedade `usableAsTool`:

```typescript
export class Hotmart extends VersionedNodeType {
  constructor() {
    const baseDescription: INodeTypeBaseDescription = {
      displayName: 'Hotmart',
      name: 'hotmart',
      icon: 'file:hotmart.svg',
      group: ['transform'],
      description: 'Interagir com a API Hotmart',
      defaultVersion: 1,
      // Adicionar propriedade usableAsTool
      usableAsTool: true,
    };

    const nodeVersions = {
      1: new HotmartV1(baseDescription),
    };

    super(nodeVersions, baseDescription);
  }
}
```

Verificar que não há incompatibilidades com a interface `INodeTypeBaseDescription` e, se necessário, usar `// @ts-ignore` caso a propriedade não esteja definida no tipo.

### 2. HotmartV1.node.ts

Não é necessário adicionar explicitamente a propriedade `usableAsTool` ao HotmartV1, pois ela é passada através do `baseDescription`. No entanto, deve-se verificar que a propagação está funcionando corretamente:

```typescript
export class HotmartV1 implements INodeType {
  description: INodeTypeDescription;

  constructor(baseDescription: INodeTypeBaseDescription) {
    // Verificar que a propriedade usableAsTool está sendo propagada corretamente
    console.assert(
      baseDescription.usableAsTool === true,
      'MCP: usableAsTool property not propagated to HotmartV1'
    );
    
    this.description = {
      ...baseDescription,
      ...versionDescription,
    };
  }

  // Resto da implementação permanece inalterado
}
```

### 3. HotmartTrigger.node.ts

Adicionar a propriedade `usableAsTool` ao node HotmartTrigger:

```typescript
export class HotmartTrigger implements INodeType {
  description: INodeTypeDescription = {
    displayName: 'Hotmart Trigger',
    name: 'hotmartTrigger',
    icon: 'file:hotmart.svg',
    group: ['trigger'],
    version: 1,
    description: 'Recebe eventos da Hotmart via webhooks',
    defaults: {
      name: 'Hotmart Trigger',
    },
    inputs: [],
    outputs: `={{$parameter["triggerMode"] === "standard" ? ['main'] : (${configureOutputNames})($parameter)}}` as any,
    // Adicionar propriedade usableAsTool
    usableAsTool: true,
    
    // Resto da implementação permanece inalterada
  };

  // Resto da implementação permanece inalterado
}
```

### 4. Verificação de Variável de Ambiente

Adicionar verificação para assegurar que a variável de ambiente `N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true` está configurada.

Essa verificação pode ser adicionada em um arquivo utilitário ou diretamente na execução:

```typescript
// Em um arquivo como utils/mcpCheck.ts
export function checkMcpEnvironment(): boolean {
  const mcpEnabled = process.env.N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE === 'true';
  if (!mcpEnabled) {
    console.warn(
      'MCP: A variável de ambiente N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true não está configurada. ' +
      'O Node Hotmart não funcionará como ferramenta MCP sem esta configuração.'
    );
  }
  return mcpEnabled;
}

// Uso em Hotmart.node.ts
import { checkMcpEnvironment } from './utils/mcpCheck';

// ...
constructor() {
  // Verificar ambiente MCP
  checkMcpEnvironment();
  
  // Resto do construtor
}
```

## Testes e Validação

### Casos de Teste

1. **Verificação de Propriedade**:
   - Verificar se a propriedade `usableAsTool` está corretamente definida como `true` em todos os lugares necessários
   - Verificar se não há erros de TypeScript relacionados à propriedade

2. **Descoberta MCP**:
   - Testar se o node é corretamente listado como ferramenta disponível pelo MCP Server Trigger
   - Verificar se o node aparece na lista de ferramentas quando solicitado via método `tools/list` do MCP

3. **Compatibilidade**:
   - Verificar que a adição da propriedade `usableAsTool` não quebra a funcionalidade existente
   - Garantir que o node continue funcionando normalmente em fluxos n8n regulares

4. **Verificação de Ambiente**:
   - Testar comportamento com variável de ambiente definida vs. não definida
   - Verificar que a mensagem de aviso apropriada é exibida quando a variável não está configurada

### Estratégia de Teste

- Testes unitários para verificar a presença da propriedade `usableAsTool`
- Testes de integração com MCP Server Trigger para verificar a descoberta de ferramentas
- Testes funcionais para garantir que o comportamento existente não foi afetado

## Considerações de Implementação

### Desafios Técnicos

- A propriedade `usableAsTool` pode não estar definida em todas as interfaces do n8n, o que pode exigir o uso de `// @ts-ignore` ou adaptações de tipo
- Pode haver bugs sutis na interação entre o sistema de tipos do TypeScript e esta nova propriedade

### Regras Aplicáveis

As seguintes regras do RULES.md são particularmente relevantes para este RFC:

- **Adição da propriedade usableAsTool**: Seguir exatamente a especificação para implementação da propriedade
- **Compatibilidade com n8n**: Garantir compatibilidade com n8n versão 0.214.0 ou superior
- **Retrocompatibilidade**: Manter funcionalidade existente intacta
- **Testabilidade**: Implementar de forma que seja testável e verificável

### Segurança

- Não há implicações de segurança significativas nesta implementação inicial
- A variável de ambiente `N8N_COMMUNITY_PACKAGES_ALLOW_TOOL_USAGE=true` é uma medida de segurança do n8n para controlar quais nós comunitários podem ser usados como ferramentas MCP

### Desempenho

- A adição da propriedade `usableAsTool` não deve ter impacto mensurável no desempenho
- O teste de ambiente adiciona uma pequena verificação, mas sem impacto significativo

## Implementação

### Arquivos a Serem Modificados

1. `nodes/Hotmart/Hotmart.node.ts`: Adicionar propriedade `usableAsTool: true`
2. `nodes/Hotmart/HotmartTrigger.node.ts`: Adicionar propriedade `usableAsTool: true`
3. Opcionalmente, criar `utils/mcpCheck.ts` para verificação de ambiente (ou implementar diretamente)

### Sequência de Implementação

1. Adicionar a propriedade `usableAsTool: true` no Hotmart.node.ts
2. Verificar a propagação para HotmartV1.node.ts
3. Adicionar a propriedade `usableAsTool: true` no HotmartTrigger.node.ts
4. Implementar verificação de variável de ambiente
5. Testar a descoberta via MCP Server Trigger

## Critérios de Aceitação

1. A propriedade `usableAsTool: true` está corretamente implementada em todos os arquivos necessários
2. O node Hotmart é descoberto pelo MCP Server Trigger
3. A verificação de ambiente funciona corretamente, exibindo aviso apropriado quando a variável não está configurada
4. Todos os testes passam, incluindo verificação de propriedade, descoberta MCP e compatibilidade
5. Não há regressões na funcionalidade existente do node Hotmart

## Relação com RFCs Futuros

Este RFC estabelece a fundação para todos os RFCs subsequentes:

- **RFC-002: Descrições Avançadas para IA** - Construirá sobre esta base para melhorar as descrições
- **RFC-003: Tratamento de Entrada/Saída MCP** - Implementará o processamento de entrada e formatação de saída MCP
- **RFC-004 a RFC-006** - Implementarão funcionalidades específicas da Hotmart via MCP
- **RFC-007: Documentação e Exemplos** - Finalizará com documentação e exemplos completos

## Conclusão

Este RFC estabelece a fundação mínima necessária para que o node Hotmart seja reconhecido como uma ferramenta MCP. Embora simples, é crucial para o sucesso do projeto, pois todas as implementações subsequentes dependerão desta base. A implementação cuidadosa e testes abrangentes garantirão uma fundação sólida para o desenvolvimento dos recursos mais avançados nos próximos RFCs.